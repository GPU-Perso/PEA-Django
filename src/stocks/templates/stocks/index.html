{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PEA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
</head>
<body class="bg-dark">

    <table class="table table-striped" style="position: relative;">
        <thead class="table-secondary" style="position: sticky;top: 0;">
        <tr>
            <th scope="col">Name</th>
            <th scope="col">Code</th>
            <th scope="col">Buy price</th>
            <th scope="col">Last price</th>
            <th scope="col">Sell price</th>
            <th scope="col">Nb</th>
            <th scope="col">Total price</th>
            <th scope="col">Timestamp</th>
            <th scope="col">
                <a href="/">Refresh (Off)</a>
                <br>
                <a href="/online/True">Refresh (On))</a>
            </th>
        </tr>
        </thead>
        <tbody class="table-dark">
        {% for stock in stocks_list %}
        {% if stock.buy_price_gap_percent > -5 %}
            <tr class="table-danger" id="row-{{ stock.code }}">
        {% elif stock.sell_price_gap_percent < 5 %}
            <tr class="table-success" id="row-{{ stock.code }}">
        {% else %}
            <tr id="row-{{ stock.code }}">
        {% endif %}
                <td>{{ stock.name }}</td>
                <td>{{ stock.code }}</td>
                <td align="right">{{ stock.buy_price }}<br><span style="font-weight: bold; color: LightCoral;">{{ stock.buy_price_gap_percent|floatformat:2 }}%</span></td>
                <td align="right">{{ stock.last_price|floatformat:2 }}</td>
                <td align="right">{{ stock.sell_price }}<br><span style="font-weight: bold; color: green;">{{ stock.sell_price_gap_percent|floatformat:2 }}%</span></td>
                <td align="right">{{ stock.nb }}</td>
                <td align="right">{{ stock.total_price|floatformat:2 }}</td>
                <td>{{ stock.timestamp }}</td>
                <td class="table-secondary"><a class="update" id="{{ stock.code }}" href="#">Refresh (On)</a></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <script>
        $(document).ready(function() {
            // Bind all update links
            $(".update").click(function(event) {
                event.preventDefault();
                update(this);
            });

            // Stock Ajax update
            var update = function(link) {
                var id = $(link).attr('id');
                var url = "update/code/"+id;
                tr = $(link).parents('tr');
                $.ajax({url: url,
                success: function(result) {
                    tr.html(result);
                }});
            }

            // Automatic Ajax updates
            $(".update").each(function(i){
                var interval = (Math.random()*300 + 60)*1000;
                var $this = $(this);
                var t = setInterval(function() {
                    update($this);
                }, interval);
            });
        });
    </script>

</body>
</html>